<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBTC PoW Miner - BSC Testnet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 800px; 
            margin: 0 auto;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 { 
            color: #f39c12; 
            font-size: 2.2em;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #ecf0f1;
            font-size: 1em;
            opacity: 0.8;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .status-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-box.connected {
            border-left: 4px solid #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }
        
        .status-box.disconnected {
            border-left: 4px solid #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }
        
        .status-label {
            font-size: 0.85em;
            color: #bdc3c7;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #ecf0f1;
        }
        
        .mining-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #f39c12;
            margin: 8px 0;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #95a5a6;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        
        button { 
            padding: 12px 16px; 
            cursor: pointer; 
            border: none; 
            border-radius: 8px; 
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #connectBtn { 
            background: linear-gradient(45deg, #3498db, #2980b9); 
            color: white; 
        }
        
        #mineBtn { 
            background: linear-gradient(45deg, #27ae60, #229954); 
            color: white; 
        }
        
        #mineBtn.mining { 
            background: linear-gradient(45deg, #e74c3c, #c0392b); 
        }
        
        .rewards-section {
            background: rgba(155, 89, 182, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(155, 89, 182, 0.3);
            margin: 15px 0;
            display: none;
        }
        
        .rewards-section.active {
            display: block;
        }
        
        .rewards-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rewards-amount {
            font-size: 1.3em;
            font-weight: bold;
            color: #9b59b6;
        }
        
        #claimBtn {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            padding: 8px 15px;
            font-size: 13px;
        }
        
        .claim-info {
            font-size: 0.75em;
            color: #bdc3c7;
            margin-top: 8px;
            text-align: center;
        }
        
        .log-section {
            margin-top: 20px;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        #activityLog { 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 12px; 
            min-height: 150px; 
            max-height: 250px;
            overflow-y: auto; 
            background-color: rgba(0, 0, 0, 0.3);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .log-entry {
            margin-bottom: 4px;
        }
        
        .log-timestamp {
            color: #7f8c8d;
        }
        
        .clear-log {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .success { color: #27ae60; }
        .warning { color: #f39c12; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #95a5a6;
            font-size: 0.8em;
        }
        
        @media (max-width: 768px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }
            
            .rewards-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚õèÔ∏è NBTC MINER</h1>
            <div class="subtitle">Proof-of-Work Mining - BSC Testnet</div>
        </div>

        <div class="status-grid">
            <div class="status-box" id="networkStatus">
                <div class="status-label">Jaringan</div>
                <div class="status-value" id="network">Memuat...</div>
            </div>
            
            <div class="status-box disconnected" id="walletStatus">
                <div class="status-label">Dompet</div>
                <div class="status-value" id="address">Belum terhubung</div>
            </div>
        </div>

        <div class="status-box" id="miningInfoBox">
            <div class="status-label">Status Mining</div>
            <div class="status-value" id="minerStatus">Siap Memulai</div>
            
            <div class="mining-stats">
                <div class="stat-item">
                    <div class="stat-label">KESULITAN</div>
                    <div class="stat-value" id="difficulty">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">CHALLENGE ID</div>
                    <div class="stat-value" id="challengeID">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">HADIAH NBTC</div>
                    <div class="stat-value" id="reward">50.0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">HALVING (HARI)</div>
                    <div class="stat-value" id="halvingDays">1457</div>
                </div>
            </div>
        </div>

        <div class="rewards-section" id="rewardsSection">
            <div class="rewards-header">
                <div>
                    <div class="status-label">PENDING REWARDS</div>
                    <div class="rewards-amount" id="pendingRewards">0 NBTC</div>
                </div>
                <button id="claimBtn">üí∞ Claim</button>
            </div>
            <div class="claim-info">
                Minimum claim: 10,000 NBTC
            </div>
        </div>

        <div class="button-group">
            <button id="connectBtn">üîó Connect Wallet</button>
            <button id="mineBtn" disabled>‚õèÔ∏è Start Mining</button>
        </div>

        <div class="log-section">
            <div class="log-header">
                <div class="status-label">üìã ACTIVITY LOG</div>
                <button class="clear-log" onclick="clearLog()">üóëÔ∏è Clear</button>
            </div>
            <div id="activityLog">
                <div class="log-entry">
                    <span class="log-timestamp">[System]</span> <span class="info">NBTC Miner started...</span>
                </div>
            </div>
        </div>

        <div class="footer">
            NBTC Mining DApp v1.0 | BSC Testnet
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <script>
        // Konfigurasi
        const CONTRACT_ADDRESS = "0x8f6868373aAe040E7F41a34F5Ea4E9Eb812DA334";
        const ABI = [
            "function mineBlock(uint256 _nonce) external",
            "function claimReward() external",
            "function canClaimReward(address user) external view returns (bool)",
            "function getPendingReward(address user) external view returns (uint256)",
            "function getMiningInfo() external view returns (uint256 difficulty, uint256 challengeID, uint256 currentReward, uint256 timeUntilNextHalving, bool canMine, uint256 yourPendingRewards, uint256 minClaimAmount)",
            "function getContractBalance() external view returns (uint256)",
            "function currentDifficulty() external view returns (uint256)",
            "function currentChallengeID() external view returns (uint256)",
            "function lastBlockTimestamp() external view returns (uint256)",
            "function lastMineTime(address) external view returns (uint256)"
        ];

        let provider, signer, contract, minerWorker, isMining = false;

        // Initialize
        window.addEventListener('load', async () => {
            await initializeApp();
        });

        async function initializeApp() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    logActivity('‚ùå Metamask not detected', 'error');
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) disconnectWallet();
                    else connectWallet();
                });

                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });

                const accounts = await provider.listAccounts();
                if (accounts.length > 0) await connectWallet();

                await updateNetworkInfo();
                logActivity('‚úÖ App ready! Connect wallet to start mining.', 'success');

            } catch (error) {
                logActivity('‚ùå Init error: ' + error.message, 'error');
            }
        }

        async function connectWallet() {
            try {
                logActivity('üîÑ Connecting to wallet...', 'info');
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                document.getElementById('address').textContent = `${address.substring(0, 6)}...${address.substring(38)}`;
                walletStatus.className = 'status-box connected';
                connectBtn.textContent = '‚úÖ Connected';
                connectBtn.disabled = true;
                mineBtn.disabled = false;
                
                await updateMiningInfo();
                logActivity(`‚úÖ Connected: ${address}`, 'success');
                
            } catch (error) {
                logActivity('‚ùå Connection failed: ' + error.message, 'error');
            }
        }

        function disconnectWallet() {
            if (isMining) stopMining();
            
            signer = null;
            contract = null;
            document.getElementById('address').textContent = 'Not connected';
            walletStatus.className = 'status-box disconnected';
            connectBtn.textContent = 'üîó Connect Wallet';
            connectBtn.disabled = false;
            mineBtn.disabled = true;
            rewardsSection.classList.remove('active');
            
            logActivity('üîå Wallet disconnected', 'warning');
        }

        async function updateNetworkInfo() {
            try {
                if (!provider) return;
                
                const network = await provider.getNetwork();
                const chainId = network.chainId;
                
                let networkName = 'Unknown';
                if (chainId === 56) networkName = 'BSC Mainnet';
                else if (chainId === 97) networkName = 'BSC Testnet';
                else if (chainId === 1) networkName = 'Ethereum';
                
                document.getElementById('network').textContent = `${networkName} (${chainId})`;
                networkStatus.className = chainId === 97 ? 'status-box connected' : 'status-box disconnected';
                
            } catch (error) {
                document.getElementById('network').textContent = 'Error';
            }
        }

        async function updateMiningInfo() {
            try {
                if (!contract) return;
                
                const miningData = await contract.getMiningInfo();
                const difficulty = miningData.difficulty.toString();
                const reward = ethers.utils.formatUnits(miningData.currentReward, 8);
                const canMine = miningData.canMine;
                const challengeID = miningData.challengeID.toString();
                const timeUntilHalving = Math.floor(miningData.timeUntilNextHalving / 86400);
                const pendingRewards = ethers.utils.formatUnits(miningData.yourPendingRewards, 8);
                const minClaimAmount = ethers.utils.formatUnits(miningData.minClaimAmount, 8);
                
                // Update UI
                difficultyElement.textContent = difficulty;
                challengeIDElement.textContent = challengeID;
                rewardElement.textContent = parseFloat(reward).toLocaleString();
                halvingDaysElement.textContent = timeUntilHalving.toLocaleString();
                minerStatusElement.textContent = canMine ? 'Ready' : 'Cooldown';
                pendingRewardsElement.textContent = parseFloat(pendingRewards).toLocaleString() + ' NBTC';
                
                // Rewards section
                if (parseFloat(pendingRewards) > 0) {
                    rewardsSection.classList.add('active');
                    const canClaim = parseFloat(pendingRewards) >= parseFloat(minClaimAmount);
                    claimBtn.disabled = !canClaim;
                } else {
                    rewardsSection.classList.remove('active');
                }
                
            } catch (error) {
                logActivity('‚ùå Update error: ' + error.message, 'error');
            }
        }

        // Event listeners
        connectBtn.addEventListener('click', connectWallet);
        mineBtn.addEventListener('click', toggleMining);
        claimBtn.addEventListener('click', claimRewards);

        function toggleMining() {
            if (isMining) stopMining();
            else startMining();
        }

        function startMining() {
            if (!contract || !signer) {
                logActivity('‚ùå Please connect wallet first', 'error');
                return;
            }
            
            provider.getNetwork().then(network => {
                if (network.chainId !== 97) {
                    logActivity('‚ùå Please switch to BSC Testnet', 'error');
                    return;
                }
            });
            
            isMining = true;
            mineBtn.textContent = 'üõë Stop Mining';
            mineBtn.classList.add('mining');
            minerStatusElement.textContent = 'Mining...';
            
            minerWorker = new Worker('worker.js');
            
            minerWorker.onmessage = async function(event) {
                const { nonce, hash, found, error } = event.data;
                
                if (error) {
                    logActivity('‚ùå Worker error: ' + error, 'error');
                    return;
                }
                
                if (found) {
                    logActivity(`üéâ Solution found! Nonce: ${nonce}`, 'success');
                    
                    try {
                        const tx = await contract.mineBlock(nonce);
                        logActivity(`üìù Transaction: ${tx.hash}`, 'info');
                        
                        const receipt = await tx.wait();
                        logActivity(`‚úÖ Block mined! Gas: ${receipt.gasUsed.toString()}`, 'success');
                        
                        await updateMiningInfo();
                        
                    } catch (error) {
                        if (error.message.includes('cooldown')) {
                            logActivity('‚è≥ Cooldown active', 'warning');
                            stopMining();
                        } else {
                            logActivity('‚ùå Mining error: ' + error.message, 'error');
                        }
                    }
                }
            };
            
            getMiningDataForWorker();
            logActivity('‚õèÔ∏è Starting mining...', 'info');
        }

        function stopMining() {
            if (minerWorker) {
                minerWorker.terminate();
                minerWorker = null;
            }
            
            isMining = false;
            mineBtn.textContent = '‚õèÔ∏è Start Mining';
            mineBtn.classList.remove('mining');
            minerStatusElement.textContent = 'Stopped';
            logActivity('‚èπÔ∏è Mining stopped', 'warning');
        }

        async function getMiningDataForWorker() {
            try {
                const address = await signer.getAddress();
                const challengeID = await contract.currentChallengeID();
                const lastBlockTimestamp = await contract.lastBlockTimestamp();
                const difficulty = await contract.currentDifficulty();
                const chainId = (await provider.getNetwork()).chainId;
                
                minerWorker.postMessage({
                    type: 'START',
                    address: address,
                    challengeID: challengeID.toString(),
                    lastBlockTimestamp: lastBlockTimestamp.toString(),
                    difficulty: difficulty.toString(),
                    chainId: chainId.toString()
                });
                
            } catch (error) {
                logActivity('‚ùå Mining data error: ' + error.message, 'error');
            }
        }

        async function claimRewards() {
            try {
                if (!contract) return;
                
                const address = await signer.getAddress();
                const canClaim = await contract.canClaimReward(address);
                
                if (!canClaim) {
                    logActivity('‚ùå Minimum 10,000 NBTC required', 'error');
                    return;
                }
                
                claimBtn.disabled = true;
                claimBtn.textContent = '‚è≥ Claiming...';
                
                const tx = await contract.claimReward();
                logActivity(`üìù Claim transaction: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                logActivity(`‚úÖ Rewards claimed!`, 'success');
                
                await updateMiningInfo();
                claimBtn.textContent = 'üí∞ Claim';
                
            } catch (error) {
                logActivity('‚ùå Claim error: ' + error.message, 'error');
                claimBtn.disabled = false;
                claimBtn.textContent = 'üí∞ Claim';
            }
        }

        function logActivity(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span class="${type}">${message}</span>`;
            activityLog.appendChild(logEntry);
            activityLog.scrollTop = activityLog.scrollHeight;
        }

        function clearLog() {
            activityLog.innerHTML = '<div class="log-entry"><span class="log-timestamp">[System]</span> <span class="info">Log cleared</span></div>';
        }

        // Auto-update
        setInterval(() => {
            if (contract && signer) updateMiningInfo();
        }, 30000);

        // DOM elements
        const difficultyElement = document.getElementById('difficulty');
        const challengeIDElement = document.getElementById('challengeID');
        const rewardElement = document.getElementById('reward');
        const halvingDaysElement = document.getElementById('halvingDays');
        const minerStatusElement = document.getElementById('minerStatus');
        const pendingRewardsElement = document.getElementById('pendingRewards');
        const rewardsSection = document.getElementById('rewardsSection');
    </script>
</body>
</html>
